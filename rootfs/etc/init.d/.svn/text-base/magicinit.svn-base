#!/bin/sh

. /etc/init.d/functions

OpDir="/tmp/usrinit"
RaidMemberDir=""
RaidMember=""
RaidDevice="/dev/md9"
MountPoint="/usr/"

if [ ! -d $OpDir ]; then
	mkdir -p $OpDir
else
	rm $OpDir -fr
	mkdir -p $OpDir
fi

for Dev in /dev/sd[a-z]1
do
	if [ ! -b $Dev ]; then
		continue
	fi
	
	Magic=`mdadm -E $Dev | grep "Magic" | awk {'print $3'}`

	if [ ! -d $OpDir/$Magic ]; then
		mkdir $OpDir/$Magic
	fi

#	echo $Dev with $Magic
	touch $OpDir/$Magic/`basename $Dev`
done

for Dir in $OpDir/*
do
	count=`ls $Dir | wc -l`
	if [ $count -ge 2 ]; then
		RaidMemberDir=$Dir
		break	
	fi
done

if [ -n $RaidMemberDir ]; then
	for Dev in $RaidMemberDir/*
	do
		Dev=/dev/`basename $Dev`
		if [ -b $Dev ]; then
			RaidMember=$RaidMember" "$Dev
		fi
	done

	echo $RaidMember in same array

	mdadm -A $RaidDevice $RaidMember --run > /dev/null 2>&1

	if [ $? -ne 0 ]; then
		echo "start array $RaidDevice failed"
		exit 1
	else
		mount $RaidDevice $MountPoint
		exit 0
	fi
else
	exit 1
fi
